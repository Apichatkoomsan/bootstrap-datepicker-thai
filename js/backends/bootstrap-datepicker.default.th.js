/**
 * Default bootstrap-datepicker backend; performs date operations manually.
 */
;(function($){
	var dates = $.fn.datepicker.dates;

	function smartFullYear(v){
		if (v>=2400) v -= 543; // thaiyear 24xx -
		return v;
	}
	
	function smartShortYear(v){
		if (v<100){
			if (v>=73) v -= 100; // 19xx
			if (v>=43) v -= 43; // thaiyear [2543..2572] -> [2000..2029]
		}
		return v ;
	}
	function dspThaiYear(language){
		return language.search('-th')>0;
	}
	function UTCDate(){
		return new Date(Date.UTC.apply(Date, arguments));
	}
	function UTCToday(){
		var today = new Date();
		return UTCDate(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate());
	}

	$.fn.datepicker.setBackend({
		name: 'thai',
		isLeapYear: function (year) {
			return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0))
		},
		getDaysInMonth: function (date) {
			var month = date.getMonth(),
				year = date.getFullYear();
			return [31, (this.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month]
		},
		validParts: /dd?|mm?|MM?|yy(?:yy)?/g,
		nonpunctuation: /[^ -\/:-@\[-`{-~\t\n\r]+/g,
		
		parseFormat: function(format){
			// IE treats \0 as a string end in inputs (truncating the value),
			// so it's a bad format delimiter, anyway
			var separators = format.replace(this.validParts, '\0').split('\0'),
				parts = format.match(this.validParts);
			if (!separators || !separators.length || !parts || parts.length == 0){
				throw new Error("Invalid date format.");
			}
			return {separators: separators, parts: parts};
		},
		parseDate: function(date, format, language) {
			if (date instanceof Date) return date;
			if (/^[-+]\d+[dmwy]([\s,]+[-+]\d+[dmwy])*$/.test(date)) {
				var part_re = /([-+]\d+)([dmwy])/,
					parts = date.match(/([-+]\d+)([dmwy])/g),
					part, dir;
				date = new Date();
				for (var i=0; i<parts.length; i++) {
					part = part_re.exec(parts[i]);
					dir = parseInt(part[1]);
					switch(part[2]){
						case 'd':
							date.setUTCDate(date.getUTCDate() + dir);
							break;
						case 'm':
							date = this.moveMonth.call(this, date, dir);
							break;
						case 'w':
							date.setUTCDate(date.getUTCDate() + dir * 7);
							break;
						case 'y':
							date = this.moveYear.call(this, date, dir);
							break;
					}
				}
				return UTCDate(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 0, 0, 0);
			}
			var format = this.parseFormat(format),
				parts = date && date.match(this.nonpunctuation) || [],
				date = UTCToday(),
				parsed = {},
				setters_order = ['yyyy', 'yy', 'M', 'MM', 'm', 'mm', 'd', 'dd'],
				setters_map = {
					yyyy: function(d,v){ return d.setUTCFullYear(smartFullYear(v)); },
					yy: function(d,v){ return d.setUTCFullYear(2000+smartShortYear(v)); },
					m: function(d,v){
						v -= 1;
						while (v<0) v += 12;
						v %= 12;
						d.setUTCMonth(v);
						while (d.getUTCMonth() != v)
							d.setUTCDate(d.getUTCDate()-1);
						return d;
					},
					d: function(d,v){ return d.setUTCDate(v); }
				},
				val, filtered, part;
				setters_map['M'] = setters_map['MM'] = setters_map['mm'] = setters_map['m'];
				setters_map['dd'] = setters_map['d'];
				date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
				if (parts.length == format.parts.length) {
					for (var i=0, cnt = format.parts.length; i < cnt; i++) {
						val = parseInt(parts[i], 10);
						part = format.parts[i];
						if (isNaN(val)) {
							switch(part) {
								case 'MM':
									filtered = $(dates[language].months).filter(function(){
										var m = this.slice(0, parts[i].length),
											p = parts[i].slice(0, m.length);
										return m == p;
									});
									val = $.inArray(filtered[0], dates[language].months) + 1;
									break;
								case 'M':
									filtered = $(dates[language].monthsShort).filter(function(){
										var m = this.slice(0, parts[i].length),
											p = parts[i].slice(0, m.length);
										return m == p;
									});
									val = $.inArray(filtered[0], dates[language].monthsShort) + 1;
									break;
							}
						}
						parsed[part] = val;
					}
				for (var i=0, s; i<setters_order.length; i++){
					s = setters_order[i];
					if (s in parsed && !isNaN(parsed[s]))
						setters_map[s](date, parsed[s])
				}
			}
			return date;
		},
		formatDate: function(date, format, language){
			format = this.parseFormat(format);
			var thaiyear = dspThaiYear(language)? 543:0 ;
			var val = {
				d: date.getUTCDate(),
				m: date.getUTCMonth() + 1,
				M: dates[language].monthsShort[date.getUTCMonth()],
				MM: dates[language].months[date.getUTCMonth()],
				yy: (thaiyear+date.getUTCFullYear()).toString().substring(2),
				yyyy: thaiyear+date.getUTCFullYear()
			};
			val.dd = (val.d < 10 ? '0' : '') + val.d;
			val.mm = (val.m < 10 ? '0' : '') + val.m;
			var date = [],
				seps = $.extend([], format.separators);
			for (var i=0, cnt = format.parts.length; i < cnt; i++) {
				if (seps.length)
					date.push(seps.shift())
				date.push(val[format.parts[i]]);
			}
			return date.join('');
		},
		moveMonth: function(date, dir){
			if (!dir) return date;
			var new_date = new Date(date.valueOf()),
					day = new_date.getUTCDate(),
					month = new_date.getUTCMonth(),
					mag = Math.abs(dir),
					new_month, test;
			dir = dir > 0 ? 1 : -1;
			if (mag == 1){
				test = dir == -1
						// If going back one month, make sure month is not current month
						// (eg, Mar 31 -> Feb 31 == Feb 28, not Mar 02)
						? function(){ return new_date.getUTCMonth() == month; }
						// If going forward one month, make sure month is as expected
						// (eg, Jan 31 -> Feb 31 == Feb 28, not Mar 02)
						: function(){ return new_date.getUTCMonth() != new_month; };
				new_month = month + dir;
				new_date.setUTCMonth(new_month);
				// Dec -> Jan (12) or Jan -> Dec (-1) -- limit expected date to 0-11
				if (new_month < 0 || new_month > 11)
						new_month = (new_month + 12) % 12;
			} else {
				// For magnitudes >1, move one month at a time...
				for (var i=0; i<mag; i++)
					// ...which might decrease the day (eg, Jan 31 to Feb 28, etc)...
					new_date = this.moveMonth(new_date, dir);
				// ...then reset the day, keeping it in the new month
				new_month = new_date.getUTCMonth();
				new_date.setUTCDate(day);
				test = function(){ return new_month != new_date.getUTCMonth(); };
			}
			// Common date-resetting loop -- if date is beyond end of month, make it
			// end of month
			while (test()){
				new_date.setUTCDate(--day);
				new_date.setUTCMonth(new_month);
			}
			return new_date;
		},
		moveYear: function(date, dir){
			return this.moveMonth(date, dir*12);
		}
	});
	// hack core datepicker
	var DatePicker = $.fn.datepicker.Constructor ;
	if (!DatePicker.prototype.fillThai){
		var _basemethod_ = $.extend({},DatePicker.prototype) ;
		$.extend(DatePicker.prototype,{
			fillThai: function(){
				var thaiyear = 543;
				var d = new Date(this.viewDate),
					year = d.getUTCFullYear(),
					month = d.getUTCMonth();

				var elem = this.picker
					.find('.datepicker-days th:eq(1)') ;
				//console.log(elem.text(),''+year,''+(year+thaiyear));
				elem.text(elem.text().replace(''+year,''+(year+thaiyear))) ;

				this.picker
					.find('.datepicker-months')
						.find('th:eq(1)').text(''+(year+thaiyear)) ;
				year = parseInt((year+thaiyear)/10, 10) * 10;
				this.picker
					.find('.datepicker-years')
						.find('th:eq(1)')
							.text(year + '-' + (year + 9))
							.end()
							.find('td')
								.find('span.year')
								.each(function(){$(this).text(Number($(this).text())+thaiyear);});
			},
			fill: function(){
				_basemethod_.fill.call(this);
				if (dspThaiYear(this.language))
					this.fillThai();
			},
			clickThai: function(e){
				var target = $(e.target).closest('span');
				if (target.length === 1 && target.is('.year'))
					target.text(Number(target.text())-543);
			},
			click: function(e){
				if (dspThaiYear(this.language))
					this.clickThai(e);
				_basemethod_.click.call(this,e);
			}
		});
	}
}(jQuery));
